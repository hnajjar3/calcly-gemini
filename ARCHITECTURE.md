# Calcly Architecture Documentation

## Abstract

Calcly is an AI-powered computational knowledge engine designed to run on modern web browsers and mobile devices. Unlike traditional chatbots that rely solely on Large Language Models (LLMs) for math, Calcly utilizes a **Hybrid Computational Architecture**. It combines the reasoning capabilities of Google's Gemini models with the deterministic precision of local JavaScript symbolic math libraries (Nerdamer, Algebrite, Math.js).

This document outlines the system architecture, data flow, AI integration strategies, and component hierarchy.

---

## 1. High-Level Architecture

Calcly operates as a Single Page Application (SPA) served by a lightweight Node.js layer for runtime environment configuration.

### System Diagram

```mermaid
graph TD
    User[User Input (Text/Voice/Image)] --> Frontend[React SPA]
    Frontend --> Router[Request Router]
    
    subgraph "Compute Layer"
        Router -->|General Knowledge| AI_Service[Gemini Service]
        Router -->|Symbolic Math| Symbolic_Engine[Symbolic Pipeline]
        Router -->|Numerical Math| Numerical_Engine[Numerical Pipeline]
    end
    
    subgraph "Local Engines (Client-Side)"
        Symbolic_Engine --> Nerdamer[Nerdamer.js]
        Symbolic_Engine --> Algebrite[Algebrite.js]
        Numerical_Engine --> MathJS[Math.js]
    end
    
    subgraph "Cloud Intelligence"
        AI_Service -->|JSON Schema| GeminiAPI[Google Gemini API]
        Symbolic_Engine -->|Parsing & Fallback| GeminiAPI
        Numerical_Engine -->|Parsing & Validation| GeminiAPI
    end
    
    GeminiAPI -->|Structured JSON| Frontend
    Nerdamer -->|LaTeX| Frontend
    MathJS -->|Result| Frontend
```

---

## 2. Core Technical Components

### 2.1 Frontend Client
- **Framework**: React 19 with Vite.
- **Language**: TypeScript.
- **Styling**: Tailwind CSS with dark mode support.
- **State Management**: React `useState` / `useRef` for local history and audio buffering.

### 2.2 Visualization & Rendering
- **Math Rendering**: `KaTeX` for high-performance LaTeX rendering.
- **Charts**: `Chart.js` via `react-chartjs-2` for rendering dynamic data sets generated by the AI.
- **Code**: `PrismJS` for syntax highlighting.
- **Markdown**: `Marked` with custom tokenization for mixing LaTeX/Markdown.

### 2.3 Server Layer (Runtime Injection)
- **Technology**: Express.js.
- **Purpose**: 
  1. Serves the static build assets.
  2. Implements **Runtime Environment Injection**. It reads `process.env.API_KEY` from the container environment (e.g., Google Cloud Run) and injects it into the `window.env` object in `index.html` at request time. This allows the same Docker image to be deployed across different environments without rebuilding.

---

## 3. The Hybrid Computational Pipeline

Calcly's core innovation is how it handles mathematical queries to avoid LLM hallucinations.

### 3.1 The Symbolic Solver (`SymbolicSolver.tsx`)
This component handles algebra, calculus, and symbolic manipulation.

1.  **Natural Language Parsing (Cloud)**: 
    *   The user's query (e.g., "Integrate x squared") is sent to Gemini Pro.
    *   The AI translates this into a standardized JSON Command: `{ operation: "integrate", expression: "x^2", variable: "x" }`.
2.  **Execution Pipeline (Local)**:
    *   The system attempts to solve the standardized command using `Algebrite`.
    *   If `Algebrite` fails or returns an echo, it attempts `Nerdamer`.
3.  **AI Verification (Closed Loop)**:
    *   The local result is sent back to a lightweight Gemini model (Flash) acting as a "Judge".
    *   The Judge validates if the local result makes sense mathematically.
4.  **Fallback**:
    *   If local engines fail or the Judge rejects the result, the system falls back to Gemini Pro to solve the problem "by hand" (pure generative AI).

### 3.2 The Numerical Solver (`NumericalSolver.tsx`)
This component handles arithmetic, statistics, and unit conversions.

1.  **Input Parsing**: User input is parsed by Gemini into valid `math.js` syntax (e.g., "Avg of 1 and 2" -> `mean(1, 2)`).
2.  **Custom Functions**: The engine injects custom implementations of `integrate` and `deriv` using numerical methods (Simpson's Rule, Central Difference) into the `math.js` scope.
3.  **Execution**: The parsed string is evaluated safely in the browser.

### 3.3 General Knowledge Engine (`ResultCard.tsx`)
For queries like "Compare GDP of US and China", Calcly forces the LLM to output **Structured JSON** rather than unstructured text.

**Schema Enforcement**:
The prompt includes a strict JSON schema requiring:
*   `interpretation`: How the AI understood the query.
*   `result`: An array of Markdown/LaTeX parts.
*   `chart`: Configuration for Chart.js (type, datasets, labels).
*   `sections`: Detailed breakdown (History, derivation, etc.).

This allows the frontend to render interactive UI components (Charts, Tables) dynamically based on the response.

---

## 4. AI Model Strategy

Calcly uses specific Gemini models for specific tasks to balance cost, latency, and intelligence.

| Task | Model | Reason |
| :--- | :--- | :--- |
| **Parsing** | `gemini-2.5-pro` | High reasoning required to convert ambiguity to strict syntax. |
| **General Solver (Pro)** | `gemini-2.5-pro` | Handles complex context, large context windows, and "Thinking" capability. |
| **General Solver (Flash)** | `gemini-2.5-flash` | Low latency, fallback for timeouts/quotas. |
| **Validation (Judge)** | `gemini-2.5-flash` | Extremely fast, cheap, sufficient for checking output validity. |
| **Voice/Audio** | `gemini-2.5-pro` | Native multimodal capabilities for processing audio blobs. |

---

## 5. Deployment & Security

### 5.1 Environment Security
API keys are **never** hardcoded.
1.  **Local Dev**: Loaded from `.env` via Vite.
2.  **Production**: Injected by `server.js` into a global `window.env` object. This prevents keys from being baked into the static bundle, allowing for secure key rotation on the server side (Cloud Run).

### 5.2 Error Handling
The `geminiService` includes a robust error handler that:
1.  Detects 429 (Quota) errors and suggests wait times.
2.  Detects timeouts and automatically retries with a faster model (Flash).
3.  Parses structured error messages from the Google Cloud API.

---

## 6. Directory Structure

```
/
├── components/          # React UI Components
│   ├── SymbolicSolver   # Nerdamer/Algebrite integration
│   ├── NumericalSolver  # Math.js integration
│   ├── ChartVisualization # Chart.js wrapper
│   └── ResultCard       # Main display logic
├── services/
│   └── geminiService.ts # API wrapper, Prompt Engineering, Fallback logic
├── types.ts             # TypeScript Interfaces (SolverResponse, HistoryItem)
├── server.js            # Express server for static serving + Env Injection
└── index.html           # Entry point with Env Placeholder
```
